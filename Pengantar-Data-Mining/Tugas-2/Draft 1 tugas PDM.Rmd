---
title: "Draft 2 TPB 1 PDM"
author: "Muhammad Ardiansyah"
date: '`r Sys.Date()`'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
getwd()
list.files()
```

# Load Data
```{r}
# Muat library
library(dplyr)       # Untuk manipulasi data (misal: pipeline %>%)
library(factoextra)  # Untuk visualisasi cluster dan penentuan K
library(cluster)     # Mengandung algoritma clustering (termasuk kmeans)
library(ggplot2)     # Untuk visualisasi (boxplots)
library(reshape2)    # Untuk 'melt' data frame (untuk ggplot)
library(ggcorrplot)  # Untuk heatmap korelasi

cat("Library berhasil dimuat.\n")
```

```{r}
# Muat data
data_raw <- read.csv("D:/Kuliah/Tugas Kuliah/semester 5/Pengantar Data Mining/Tugas 123/Customer Data.csv")
```

```{r}
# Eksplorasi singkat
cat("Struktur data awal:\n")
print(glimpse(data_raw))
```

```{r}
str(data_raw)
```
```{r}
# Seleksi fitur
 data_pre <- data_raw %>% select(-CUST_ID)
```

# EDA
```{r}
cat("\nMembuat heatmap korelasi...\n")
corr_matrix <- cor(data_pre, use = "pairwise.complete.obs")
  
# Visualisasi heatmap
p_corr <- ggcorrplot(corr_matrix, 
                     type = "lower",     
                     lab = TRUE,
                     lab_size = 1,
                     ggtheme = theme_minimal(),
                     title = "Heatmap Korelasi Fitur") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, size = 6), 
        axis.text.y = element_text(size = 6),                      
        plot.margin = unit(c(0.01, 0.01, 0.01, 0.01), "cm"))      
  
print(p_corr)
cat("Heatmap korelasi telah dibuat. Lihat jendela Plots.\n")
```


# Preprocessing

```{r}
# Missing value
cat("\nMissing values (NA) per kolom:\n")
print(sapply(data_pre, function(x) sum(is.na(x))))
```

```{r}
  # Imputasi dengan Median (lebih kuat terhadap outlier daripada Mean).
data_imputed <- data_pre %>%
  mutate(
    MINIMUM_PAYMENTS = ifelse(is.na(MINIMUM_PAYMENTS), 
                                median(MINIMUM_PAYMENTS, na.rm = TRUE), 
                                MINIMUM_PAYMENTS),
    CREDIT_LIMIT = ifelse(is.na(CREDIT_LIMIT), 
                          median(CREDIT_LIMIT, na.rm = TRUE), 
                          CREDIT_LIMIT)
    )
  
cat("\nMissing values setelah imputasi:\n")
print(sapply(data_imputed, function(x) sum(is.na(x))))
```
```{r}
cat("\nMembuat boxplots untuk visualisasi outlier...\n")
  
cols_to_plot <- names(data_imputed)
  
data_melted_viz <- melt(data_imputed)
    
p_boxplots_pre <- ggplot(data_melted_viz, aes(x = variable, y = value)) +
  geom_boxplot(fill = "steelblue", outlier.color = "red", outlier.alpha = 0.3) +
  facet_wrap(~ variable, scales = "free_y", ncol = 6) +
  theme_minimal() +
  labs(title = "Visualisasi Outlier (SEBELUM Penanganan)",
       x = "Fitur", y = "Nilai") +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    strip.text = element_text(size = 4, margin = margin(t = 2, b = 2)),
    plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm") 
    )
    
  print(p_boxplots_pre)
```

```{r}
# Menangani outlier dengan log transform
  
# Tentukan kolom finansial yang skewed (sama dengan 'cols_to_plot')
cols_to_log <- cols_to_plot
  
data_transformed <- data_imputed
# Terapkan log1p hanya ke kolom yang ditentukan
data_transformed[cols_to_log] <- lapply(data_transformed[cols_to_log], function(x) log1p(x))
```

```{r}
# Setelah outlier ditangani
data_melted_post <- melt(data_transformed)
p_boxplots_post <- ggplot(data_melted_post, aes(x = variable, y = value)) +
  geom_boxplot(fill = "darkgreen", outlier.color = "orange") +
  facet_wrap(~ variable, scales = "free_y", ncol = 6) +
  theme_minimal() +
  labs(title = "Visualisasi Distribusi (SETELAH Log Transform)",
       x = "Fitur", y = "Nilai Log(x+1)") +
  theme(
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    strip.text = element_text(size = 4, margin = margin(t = 2, b = 2)), 
    plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm") 
    )
    
print(p_boxplots_post)
```

```{r}
# Scalling
# Kita standardisasi semua fitur (mean=0, std.dev=1).
data_scaled <- scale(data_transformed)
data_scaled <- as.data.frame(data_transformed) # Konversi matriks 'scale' ke data frame
summary(data_scaled)
```

# Penentuan K optimal
```{r}
# set.seed untuk hasil yang konsisten/reproduktif
set.seed(123)

# Elbow Method
# Mencari titik "siku" dimana penambahan cluster baru tidak lagi
# memberikan penurunan drastis pada 'within-cluster sum of squares' (WSS).
p_elbow <- fviz_nbclust(data_scaled, kmeans, method = "wss") +
  labs(title = "Elbow Method",
       subtitle = "Mencari K optimal")
print(p_elbow) 
```
```{r}
# Metode Silhouette
# Mengukur seberapa baik data terpisah antar cluster.
# Cari nilai K yang memberikan skor Silhouette tertinggi.
p_silhouette <- fviz_nbclust(data_scaled, kmeans, method = "silhouette") +
  labs(title = "Metode Silhouette",
       subtitle = "Mencari K optimal")
  
print(p_silhouette)
```
```{r}
K_OPTIMAL <- 6
```

# Modelling dengan k-means
```{r}
set.seed(123)
final_model <- kmeans(data_scaled, centers = K_OPTIMAL, nstart = 25)
```

```{r}
# Visualisasi Cluster
  
# K-Means tidak sensitif terhadap urutan, jadi tidak ada 'peringkat' cluster.
  
p_cluster_viz <- fviz_cluster(final_model, data = data_scaled,
                              palette = "jco", # Skema warna
                              ggtheme = theme_minimal(),
                              main = paste("Visualisasi Cluster K-Means (K=", K_OPTIMAL, ")"),
                              ellipse.type = "convex", # Menggambar 'amplop' di sekitar cluster
                              geom = "point",
                              pointsize = 0.5,
                              show.clust.cent = TRUE)
print(p_cluster_viz)
cat("Visualisasi cluster telah dibuat. Lihat jendela Plots.\n")
```
```{r}
# Interpretasi (Profiling Persona)
  
# Kita tambahkan label cluster ke data SEBELUM scaling (data_imputed)
# agar kita bisa menginterpretasikan nilai aslinya (misal: Dollar, bukan Z-score)
  
data_final <- data_imputed %>%
  mutate(Cluster = final_model$cluster)
# Sekarang, kita hitung nilai RATA-RATA setiap fitur, dikelompokkan berdasarkan Cluster
cluster_personas <- data_final %>%
  group_by(Cluster) %>%
  summarise_all(mean) %>%
  as.data.frame()
  
cat("\n--- PROFILING PERSONA CLUSTER (Rata-rata Fitur) ---\n")
print(cluster_personas)
```

```{r}
  
cat("\n--- UKURAN CLUSTER ---\n")
print(final_model$size)
```



































